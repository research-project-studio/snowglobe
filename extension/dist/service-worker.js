(()=>{"use strict";const e=new Map,t=new Map,s=new Map,o=new Map;let r=!1;function n(e,t){t>0?(chrome.action.setBadgeText({text:t.toString(),tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50",tabId:e}),chrome.action.setTitle({title:`WebMap Archiver (${t} map${t>1?"s":""} detected)`,tabId:e})):(chrome.action.setBadgeText({text:"",tabId:e}),chrome.action.setTitle({title:"WebMap Archiver",tabId:e}))}function a(e,t){const s=t<100?`${t}%`:"âœ“";chrome.action.setBadgeText({text:s,tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#2196F3",tabId:e})}chrome.runtime.onMessage.addListener((i,c,d)=>{const u=c.tab?.id||i.tabId;switch(i.type){case"MAPS_DETECTED":u&&function(s,o,r){e.set(s,{count:o,types:r.map(e=>e.type)});const a=t.get(s);a&&"recording"===a.status||n(s,o)}(u,i.count,i.maps);break;case"GET_TAB_STATE":i.tabId&&d({maps:e.get(i.tabId)||{count:0,types:[]},capture:t.get(i.tabId)||{status:"idle"}});break;case"START_CAPTURE":return i.tabId&&async function(e){try{return await chrome.permissions.contains({permissions:["debugger"]})||await chrome.permissions.request({permissions:["debugger"]})?(r||void 0!==chrome.debugger&&(chrome.debugger.onEvent.addListener((e,r,n)=>{const a=e.tabId;if(!a)return;const i=t.get(a);if(i&&"recording"===i.status)switch(r){case"Network.responseReceived":!function(e,r){const{requestId:n,response:a}=r,{url:i,status:c,mimeType:d}=a,u=function(e){const t=[/\/(\d+)\/(\d+)\/(\d+)\.(pbf|mvt|png|jpg|jpeg|webp|avif)/,/\/tiles\/(\d+)\/(\d+)\/(\d+)/,/[?&]z=(\d+)&x=(\d+)&y=(\d+)/];for(const s of t){const t=e.match(s);if(t){const[,s,o,r]=t,n=new URL(e).hostname.split(".")[0]||"tiles";return{coords:{z:parseInt(s),x:parseInt(o),y:parseInt(r)},source:n}}}return null}(i),l={url:i,method:"GET",status:c,mimeType:d,responseSize:0,timestamp:Date.now(),isTile:null!==u,tileCoords:u?.coords,tileSource:u?.source},p=s.get(e)||[];p.push(l),s.set(e,p),o.set(n,{tabId:e,requestId:n});const g=t.get(e);"recording"===g?.status&&(g.totalRequests++,u&&(g.tileCount++,g.zoomLevels.includes(u.coords.z)||(g.zoomLevels.push(u.coords.z),g.zoomLevels.sort((e,t)=>e-t))))}(a,n);break;case"Network.loadingFinished":!async function(e,r){const{requestId:n,encodedDataLength:a}=r;if(!o.get(n))return;o.delete(n);const i=s.get(e);if(!i)return;const c=i.find(e=>e.url&&!e.responseBody);if(c&&(c.responseSize=a,(c.isTile||c.mimeType.includes("json")||c.url.includes("sprite")||c.url.includes("glyphs"))&&a<10485760))try{const s=await chrome.debugger.sendCommand({tabId:e},"Network.getResponseBody",{requestId:n});c.responseBody=s.base64Encoded?s.body:btoa(s.body);const o=t.get(e);"recording"===o?.status&&(o.estimatedSize+=a)}catch(e){console.debug(`[WebMap Archiver] Could not get body for ${c.url}`)}}(a,n)}}),r=!0,console.log("[WebMap Archiver] Debugger event listener attached")),t.set(e,{status:"recording",startedAt:(new Date).toISOString(),tileCount:0,totalRequests:0,zoomLevels:[],estimatedSize:0}),s.set(e,[]),await chrome.debugger.attach({tabId:e},"1.3"),await chrome.debugger.sendCommand({tabId:e},"Network.enable",{maxResourceBufferSize:104857600,maxTotalBufferSize:209715200}),chrome.action.setBadgeText({text:"REC",tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#f44336",tabId:e}),console.log(`[WebMap Archiver] Started recording for tab ${e}`),{success:!0}):{success:!1,error:"Debugger permission required for tile capture"}}catch(s){return console.error("[WebMap Archiver] Failed to start capture:",s),t.set(e,{status:"error",message:String(s)}),{success:!1,error:String(s)}}}(i.tabId).then(d),!0;case"STOP_CAPTURE":return i.tabId&&async function(e){const o=t.get(e);if(!o||"recording"!==o.status)return{success:!1,error:"Not recording"};try{await chrome.debugger.detach({tabId:e}),t.set(e,{status:"processing",progress:10,message:"Building capture bundle..."}),a(e,10);const r=s.get(e)||[];t.set(e,{status:"processing",progress:30,message:"Capturing map style..."}),a(e,30);const n=await chrome.tabs.sendMessage(e,{type:"CAPTURE_STYLE"}),i=await chrome.tabs.sendMessage(e,{type:"GET_PAGE_INFO"});t.set(e,{status:"processing",progress:50,message:"Processing tiles..."}),a(e,50);const c=function(e,t,s,o){const r=e.filter(e=>e.isTile&&e.responseBody).map(e=>({z:e.tileCoords.z,x:e.tileCoords.x,y:e.tileCoords.y,source:e.tileSource,data:e.responseBody,format:e.mimeType.includes("png")?"png":"pbf"})),n={log:{version:"1.2",creator:{name:"WebMap Archiver",version:"0.1.0"},entries:e.map(e=>({startedDateTime:new Date(e.timestamp).toISOString(),request:{method:e.method,url:e.url,headers:[]},response:{status:e.status,statusText:"OK",headers:[],content:{size:e.responseSize,mimeType:e.mimeType,text:e.responseBody,encoding:e.responseBody?"base64":void 0}},timings:{wait:0,receive:0}}))}};return{version:"1.0",metadata:{url:s.url,title:s.title,capturedAt:(new Date).toISOString(),userAgent:navigator.userAgent,mapLibrary:t?.mapLibrary,captureStats:{totalRequests:e.length,tileCount:r.length,zoomLevels:o.zoomLevels,estimatedSize:o.estimatedSize,recordingDuration:Date.now()-new Date(o.startedAt).getTime()}},viewport:t?.viewport?{center:[t.viewport.center.lng,t.viewport.center.lat],zoom:t.viewport.zoom,bounds:t.viewport.bounds?[[t.viewport.bounds._sw.lng,t.viewport.bounds._sw.lat],[t.viewport.bounds._ne.lng,t.viewport.bounds._ne.lat]]:void 0,bearing:t.viewport.bearing||0,pitch:t.viewport.pitch||0}:{center:[0,0],zoom:10},style:t?.style,har:n,tiles:r}}(r,n,i,o);return s.delete(e),console.log(`[WebMap Archiver] Capture complete: ${c.tiles?.length||0} tiles`),{success:!0,bundle:c}}catch(s){return console.error("[WebMap Archiver] Failed to stop capture:",s),t.set(e,{status:"error",message:String(s)}),{success:!1,error:String(s)}}}(i.tabId).then(d),!0;case"CANCEL_CAPTURE":i.tabId&&(async function(o){try{await chrome.debugger.detach({tabId:o})}catch{}t.set(o,{status:"idle"}),s.delete(o);const r=e.get(o);n(o,r?.count||0)}(i.tabId),d({success:!0}));break;case"PROCESS_BUNDLE":return async function(e){const t=function(){const e=["https://mariogiampieri--webmap-archiver-fastapi-app.modal.run/process"];return e.push("http://localhost:8765"),e.push("http://localhost:8000"),e}();for(const s of t)try{console.log(`[WebMap Archiver] Trying endpoint: ${s}`);const t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(3e5)});if(!t.ok){console.warn(`[WebMap Archiver] ${s} returned ${t.status}`);continue}const o=await t.json();if(o.success)return console.log(`[WebMap Archiver] Processing successful via ${s}`),{success:!0,downloadUrl:o.downloadUrl,filename:o.filename,size:o.size};console.warn(`[WebMap Archiver] ${s} processing failed:`,o.error);continue}catch(e){console.warn(`[WebMap Archiver] ${s} request failed:`,e);continue}return console.log("[WebMap Archiver] All processing endpoints failed, falling back to bundle download"),{success:!1,fallbackToDownload:!0,error:"Processing services unavailable"}}(i.bundle).then(d),!0;case"DOWNLOAD_BUNDLE":!function(e,t){const s=JSON.stringify(e,null,2),o=new Blob([s],{type:"application/json"}),r=URL.createObjectURL(o);chrome.downloads.download({url:r,filename:t,saveAs:!0}),setTimeout(()=>URL.revokeObjectURL(r),1e4)}(i.bundle,i.filename)}}),chrome.tabs.onRemoved.addListener(o=>{e.delete(o),t.delete(o),s.delete(o)})})();