(()=>{"use strict";const e=new Map,t=new Map;function o(e,t){t>0?(chrome.action.setBadgeText({text:t.toString(),tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50",tabId:e}),chrome.action.setTitle({title:`WebMap Archiver (${t} map${t>1?"s":""} detected)`,tabId:e})):(chrome.action.setBadgeText({text:"",tabId:e}),chrome.action.setTitle({title:"WebMap Archiver",tabId:e}))}console.log("[WebMap Archiver] Service worker initialized"),chrome.runtime.onMessage.addListener((s,a,n)=>{const c=a.tab?.id||s.tabId;switch(s.type){case"MAPS_DETECTED":c&&function(s,a,n){e.set(s,{count:a,types:n.map(e=>e.type)});const c=t.get(s);c&&"recording"===c.status||o(s,a)}(c,s.count,s.maps);break;case"GET_TAB_STATE":s.tabId&&n({maps:e.get(s.tabId)||{count:0,types:[]},capture:t.get(s.tabId)||{status:"idle"}});break;case"CAPTURE_STARTED":s.tabId&&(t.set(s.tabId,{status:"recording",startedAt:(new Date).toISOString(),tileCount:0,totalRequests:0,zoomLevels:[],estimatedSize:0}),function(e){chrome.action.setBadgeText({text:"REC",tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#f44336",tabId:e}),chrome.action.setTitle({title:"WebMap Archiver (Recording...)",tabId:e})}(s.tabId),n({success:!0}));break;case"CAPTURE_STATS_UPDATE":if(s.tabId){const e=t.get(s.tabId);"recording"===e?.status&&Object.assign(e,s.stats)}break;case"CAPTURE_STOPPED":if(s.tabId){t.set(s.tabId,{status:"idle"});const a=e.get(s.tabId);o(s.tabId,a?.count||0),n({success:!0})}break;case"PROCESS_BUNDLE":return async function(e){const t=function(){const e=["https://mariogiampieri--webmap-archiver-fastapi-app.modal.run/process"];return e.push("http://localhost:8765/process"),e.push("http://localhost:8000/process"),e}();console.log("[WebMap Archiver] Processing bundle with endpoints:",t),console.log("[WebMap Archiver] Bundle summary:",{tiles:e.tiles?.length||0,harEntries:e.har?.log?.entries?.length||0,hasStyle:!!e.style});for(const o of t)try{console.log(`[WebMap Archiver] Trying endpoint: ${o}`);const t=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(3e5)});if(!t.ok){const e=await t.text();console.warn(`[WebMap Archiver] ${o} returned ${t.status}:`,e);continue}const s=await t.json();if(console.log("[WebMap Archiver] Response:",s),s.success){let e=s.downloadUrl;if(e&&e.startsWith("/")){const t=new URL(o);e=`${t.protocol}//${t.host}${e}`,console.log(`[WebMap Archiver] Fixed URL: ${e}`)}return{success:!0,downloadUrl:e,filename:s.filename,size:s.size}}console.warn("[WebMap Archiver] Processing failed:",s.error);continue}catch(e){console.warn("[WebMap Archiver] Request failed:",e);continue}return{success:!1,fallbackToDownload:!0,error:"Processing services unavailable"}}(s.bundle).then(n),!0;case"DOWNLOAD_BUNDLE":!function(e,t){const o=JSON.stringify(e,null,2),s=new Blob([o],{type:"application/json"}),a=URL.createObjectURL(s);chrome.downloads.download({url:a,filename:t,saveAs:!0}),setTimeout(()=>URL.revokeObjectURL(a),1e4)}(s.bundle,s.filename),n({success:!0});break;case"DOWNLOAD_FILE":chrome.downloads.download({url:s.url,filename:s.filename,saveAs:!0}),n({success:!0})}}),chrome.tabs.onRemoved.addListener(o=>{e.delete(o),t.delete(o)}),console.log("[WebMap Archiver] Service worker ready")})();