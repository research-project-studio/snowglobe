(()=>{"use strict";const e=new Map,t=new Map;function o(e,t){t>0?(chrome.action.setBadgeText({text:t.toString(),tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50",tabId:e}),chrome.action.setTitle({title:`WebMap Archiver (${t} map${t>1?"s":""} detected)`,tabId:e})):(chrome.action.setBadgeText({text:"",tabId:e}),chrome.action.setTitle({title:"WebMap Archiver",tabId:e}))}console.log("[WebMap Archiver] Service worker initialized"),chrome.runtime.onMessage.addListener((n,a,s)=>{const r=a.tab?.id||n.tabId;switch(n.type){case"MAPS_DETECTED":r&&function(n,a,s){e.set(n,{count:a,types:s.map(e=>e.type)});const r=t.get(n);r&&"recording"===r.status||o(n,a)}(r,n.count,n.maps);break;case"GET_TAB_STATE":if(n.tabId){const o=e.get(n.tabId),a=t.get(n.tabId)||{status:"idle"};s({maps:o||{count:0,types:[]},capture:a})}break;case"EXECUTE_CAPTURE_SCRIPT":if(n.tabId)return chrome.scripting.executeScript({target:{tabId:n.tabId},func:()=>{const e=window.__webmapArchiver?.detectedMaps||[];if(0===e.length)return null;const t=e[0]?.instance;if(!t)return null;try{return{style:"function"==typeof t.getStyle?t.getStyle():null,viewport:{center:t.getCenter?.()||{lng:0,lat:0},zoom:t.getZoom?.()||10,bounds:t.getBounds?.()||null,bearing:t.getBearing?.()||0,pitch:t.getPitch?.()||0},mapLibrary:e[0]?.type?{type:e[0].type,version:e[0].version}:null}}catch(e){return console.error("Error capturing map state:",e),null}}}).then(e=>{s(e?.[0]?.result||null)}).catch(e=>{console.error("Script execution failed:",e),s(null)}),!0;break;case"CAPTURE_STARTED":n.tabId&&(t.set(n.tabId,{status:"recording",startedAt:(new Date).toISOString(),tileCount:0,totalRequests:0,zoomLevels:[],estimatedSize:0}),function(e){chrome.action.setBadgeText({text:"REC",tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#f44336",tabId:e}),chrome.action.setTitle({title:"WebMap Archiver (Recording...)",tabId:e})}(n.tabId),s({success:!0}));break;case"CAPTURE_STATS_UPDATE":if(n.tabId){const e=t.get(n.tabId);"recording"===e?.status&&Object.assign(e,n.stats)}break;case"CAPTURE_STOPPED":if(n.tabId){t.set(n.tabId,{status:"idle"});const a=e.get(n.tabId);o(n.tabId,a?.count||0),s({success:!0})}break;case"PROCESS_BUNDLE":return async function(e){const t=function(){const e=["https://mariogiampieri--webmap-archiver-fastapi-app.modal.run/process"];return e.push("http://localhost:8765/process"),e.push("http://localhost:8000/process"),e}();console.log("[WebMap Archiver] Processing bundle with endpoints:",t),console.log("[WebMap Archiver] Bundle summary:",{tiles:e.tiles?.length||0,harEntries:e.har?.log?.entries?.length||0,hasStyle:!!e.style});for(const o of t)try{console.log(`[WebMap Archiver] Trying endpoint: ${o}`);const t=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(3e5)});if(!t.ok){const e=await t.text();console.warn(`[WebMap Archiver] ${o} returned ${t.status}:`,e);continue}const n=await t.json();if(console.log("[WebMap Archiver] Response:",n),n.success){let e=n.downloadUrl;if(e&&e.startsWith("/")){const t=new URL(o);e=`${t.protocol}//${t.host}${e}`,console.log(`[WebMap Archiver] Fixed download URL: ${e}`)}return{success:!0,downloadUrl:e,filename:n.filename,size:n.size}}console.warn("[WebMap Archiver] Processing failed:",n.error);continue}catch(e){console.warn("[WebMap Archiver] Request failed:",e);continue}return{success:!1,fallbackToDownload:!0,error:"Processing services unavailable"}}(n.bundle).then(s),!0;case"DOWNLOAD_BUNDLE":!function(e,t){const o=JSON.stringify(e,null,2),n=new Blob([o],{type:"application/json"}),a=URL.createObjectURL(n);chrome.downloads.download({url:a,filename:t,saveAs:!0}),setTimeout(()=>URL.revokeObjectURL(a),1e4)}(n.bundle,n.filename),s({success:!0});break;case"DOWNLOAD_FILE":chrome.downloads.download({url:n.url,filename:n.filename,saveAs:!0}),s({success:!0})}}),chrome.tabs.onRemoved.addListener(o=>{e.delete(o),t.delete(o)}),console.log("[WebMap Archiver] Service worker ready")})();