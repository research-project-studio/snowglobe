(()=>{"use strict";class e{constructor(){this.detectedMaps=[],this.observer=null}detect(){return this.detectedMaps=[],this.detectByDOM(),this.detectMapLibreGL(),this.detectMapboxGL(),this.detectLeaflet(),this.detectOpenLayers(),this.detectedMaps}observe(e){this.observer&&this.observer.disconnect(),this.observer=new MutationObserver(()=>{const t=this.detect();t.length>0&&e(t)}),this.observer.observe(document.body,{childList:!0,subtree:!0})}disconnect(){this.observer&&(this.observer.disconnect(),this.observer=null)}detectByDOM(){document.querySelectorAll(".maplibregl-map").forEach(e=>{if(!this.isAlreadyDetected(e)){const t=this.getMapInstance(e,"maplibre");this.detectedMaps.push({type:"maplibre",version:window.maplibregl?.version,element:e,instance:t})}}),document.querySelectorAll(".mapboxgl-map").forEach(e=>{if(!this.isAlreadyDetected(e)){const t=this.getMapInstance(e,"mapbox");this.detectedMaps.push({type:"mapbox",version:window.mapboxgl?.version,element:e,instance:t})}}),document.querySelectorAll(".leaflet-container").forEach(e=>{if(!this.isAlreadyDetected(e)){const t=this.getMapInstance(e,"leaflet");this.detectedMaps.push({type:"leaflet",version:window.L?.version,element:e,instance:t})}}),document.querySelectorAll(".ol-viewport").forEach(e=>{const t=e.parentElement;t&&!this.isAlreadyDetected(t)&&this.detectedMaps.push({type:"openlayers",version:void 0,element:t,instance:null})}),document.querySelectorAll("canvas").forEach(e=>{const t=e.parentElement;t&&(this.isAlreadyDetected(t)||this.isAlreadyDetected(e)||t.className.toLowerCase().includes("map")&&this.detectedMaps.push({type:"unknown",element:t,instance:null}))})}detectMapLibreGL(){window.maplibregl&&document.querySelectorAll(".maplibregl-map").forEach(e=>{if(this.isAlreadyDetected(e)){const t=this.detectedMaps.find(t=>t.element===e);return t&&!t.version&&(t.version=window.maplibregl?.version),void(t&&!t.instance&&(t.instance=this.getMapInstance(e,"maplibre")||this.findMapInstanceOnWindow(e,"maplibre")))}let t=this.getMapInstance(e,"maplibre");t||(t=this.findMapInstanceOnWindow(e,"maplibre")),this.detectedMaps.push({type:"maplibre",version:window.maplibregl?.version,element:e,instance:t})})}detectMapboxGL(){window.mapboxgl&&document.querySelectorAll(".mapboxgl-map").forEach(e=>{if(this.isAlreadyDetected(e)){const t=this.detectedMaps.find(t=>t.element===e);return t&&!t.version&&(t.version=window.mapboxgl?.version),void(t&&!t.instance&&(t.instance=this.getMapInstance(e,"mapbox")))}const t=this.getMapInstance(e,"mapbox");this.detectedMaps.push({type:"mapbox",version:window.mapboxgl?.version,element:e,instance:t})})}detectLeaflet(){window.L&&document.querySelectorAll(".leaflet-container").forEach(e=>{if(this.isAlreadyDetected(e)){const t=this.detectedMaps.find(t=>t.element===e);return t&&!t.version&&(t.version=window.L?.version),void(t&&!t.instance&&(t.instance=this.getMapInstance(e,"leaflet")))}const t=this.getMapInstance(e,"leaflet");this.detectedMaps.push({type:"leaflet",version:window.L?.version,element:e,instance:t})})}detectOpenLayers(){window.ol&&document.querySelectorAll(".ol-viewport").forEach(e=>{const t=e.parentElement;t&&!this.isAlreadyDetected(t)&&this.detectedMaps.push({type:"openlayers",version:void 0,element:t,instance:null})})}getMapInstance(e,t){const n=["_map","__map","map","_leaflet_map","__maplibregl","__mapboxgl"];for(const o of n){const n=e[o];if(n&&"object"==typeof n&&this.isValidMapInstance(n,t))return n}return Object.keys(e).find(e=>e.startsWith("__reactFiber")||e.startsWith("__reactInternalInstance")),null}isValidMapInstance(e,t){if(!e||"object"!=typeof e)return!1;const n=e;switch(t){case"maplibre":case"mapbox":return"function"==typeof n.getStyle&&"function"==typeof n.getCenter&&"function"==typeof n.getZoom;case"leaflet":return"function"==typeof n.getCenter&&"function"==typeof n.getZoom&&"function"==typeof n.getBounds;default:return!1}}findMapInstanceOnWindow(e,t){const n=window;for(const o of Object.keys(n))try{const s=n[o];if(s&&"object"==typeof s){const n=s;if(this.isValidMapInstance(s,t)&&"function"==typeof n.getContainer){const t=n.getContainer();if(t===e||t?.contains?.(e))return s}}}catch{continue}return null}isAlreadyDetected(e){return this.detectedMaps.some(t=>t.element===e)}}let t=[],n=null;function o(){n=new e,t=n.detect(),s(),n.observe(e=>{t=e,s()}),setTimeout(()=>{t=n.detect(),s()},2e3)}function s(){chrome.runtime.sendMessage({type:"MAPS_DETECTED",count:t.length,maps:t.map(e=>({type:e.type,version:e.version}))})}chrome.runtime.onMessage.addListener((e,n,o)=>{switch(e.type){case"GET_MAPS":o({count:t.length,maps:t.map(e=>({type:e.type,version:e.version}))});break;case"CAPTURE_STYLE":return new Promise(e=>{const t=document.createElement("script");t.textContent="\n      (function() {\n        // Helper function to capture from a map instance\n        function captureFromInstance(instance) {\n          if (instance && typeof instance.getStyle === 'function') {\n            try {\n              const style = instance.getStyle();\n              const viewport = {\n                center: instance.getCenter?.() || [0, 0],\n                zoom: instance.getZoom?.() || 0,\n                bounds: instance.getBounds?.(),\n                bearing: instance.getBearing?.() || 0,\n                pitch: instance.getPitch?.() || 0,\n              };\n              window.postMessage({\n                type: 'WEBMAP_ARCHIVER_CAPTURE',\n                style: style,\n                viewport: viewport,\n              }, '*');\n              return true;\n            } catch (e) {\n              console.error('WebMap Archiver: Failed to capture style', e);\n            }\n          }\n          return false;\n        }\n\n        // Strategy 1: Check common window properties\n        const windowCandidates = [\n          window.map,\n          window.maplibreMap,\n          window.mapboxMap,\n        ];\n\n        for (const candidate of windowCandidates) {\n          if (captureFromInstance(candidate)) return;\n        }\n\n        // Strategy 2: Check map containers with special properties\n        const containers = document.querySelectorAll('.maplibregl-map, .mapboxgl-map');\n        for (const container of containers) {\n          // Try MapLibre/Mapbox internal properties\n          if (captureFromInstance(container.__maplibregl_map)) return;\n          if (captureFromInstance(container.__mapboxgl_map)) return;\n\n          // Try common custom property names\n          for (const prop of ['_map', '__map', 'map']) {\n            if (captureFromInstance(container[prop])) return;\n          }\n\n          // Try React fiber internals (for React apps)\n          try {\n            const fiberKey = Object.keys(container).find(k => k.startsWith('__reactFiber'));\n            if (fiberKey) {\n              const fiber = container[fiberKey];\n              // Walk up the fiber tree looking for map instance\n              let current = fiber;\n              let depth = 0;\n              while (current && depth < 20) {\n                // Check memoizedState (hooks)\n                if (current.memoizedState) {\n                  let state = current.memoizedState;\n                  while (state) {\n                    if (captureFromInstance(state.memoizedState)) return;\n                    state = state.next;\n                  }\n                }\n                // Check memoizedProps\n                if (current.memoizedProps) {\n                  for (const key in current.memoizedProps) {\n                    if (captureFromInstance(current.memoizedProps[key])) return;\n                  }\n                }\n                // Check stateNode (class component instance)\n                if (current.stateNode && typeof current.stateNode === 'object') {\n                  for (const key in current.stateNode) {\n                    if (captureFromInstance(current.stateNode[key])) return;\n                  }\n                }\n                current = current.return;\n                depth++;\n              }\n            }\n          } catch (e) {\n            console.error('React fiber traversal error:', e);\n          }\n        }\n\n        // Strategy 3: Fallback - scan all window properties\n        for (const key of Object.keys(window)) {\n          const obj = window[key];\n          if (captureFromInstance(obj)) return;\n        }\n\n        // No map found\n        window.postMessage({ type: 'WEBMAP_ARCHIVER_CAPTURE', style: null }, '*');\n      })();\n    ";const n=t=>{"WEBMAP_ARCHIVER_CAPTURE"===t.data?.type&&(window.removeEventListener("message",n),e(t.data.style))};window.addEventListener("message",n),document.documentElement.appendChild(t),t.remove(),setTimeout(()=>{window.removeEventListener("message",n),e(null)},5e3)}).then(e=>{o(e)}),!0;case"GET_PAGE_INFO":o({url:window.location.href,title:document.title})}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o()})();