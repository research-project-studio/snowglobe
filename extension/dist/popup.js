(()=>{"use strict";const e=document.getElementById("no-map"),t=document.getElementById("map-found"),n=document.getElementById("recording"),s=document.getElementById("processing"),a=document.getElementById("complete"),o=document.getElementById("error"),d=document.getElementById("map-info"),i=document.getElementById("start-capture-btn"),c=document.getElementById("tile-count"),r=document.getElementById("zoom-levels"),l=document.getElementById("data-size"),u=document.getElementById("stop-capture-btn"),m=document.getElementById("cancel-capture-btn"),p=(document.getElementById("processing-message"),document.getElementById("progress-fill")),g=document.getElementById("progress-text"),y=document.getElementById("filename"),b=(document.getElementById("stats-summary"),document.getElementById("new-capture-btn")),f=document.getElementById("error-message"),h=document.getElementById("retry-btn");let E=null,w=null;async function v(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)return void $("Cannot access current tab");E=e.id;const t=await chrome.runtime.sendMessage({type:"GET_TAB_STATE",tabId:e.id});"recording"===t.capture?.status?(A(t.capture),D()):"processing"===t.capture?.status?C(t.capture.progress,t.capture.message):t.maps?.count>0?I(t.maps):B(),i.addEventListener("click",S),u.addEventListener("click",z),m.addEventListener("click",k),b.addEventListener("click",_),h.addEventListener("click",v)}function L(){e.classList.add("hidden"),t.classList.add("hidden"),n.classList.add("hidden"),s.classList.add("hidden"),a.classList.add("hidden"),o.classList.add("hidden")}function B(){L(),e.classList.remove("hidden")}function I(e){L(),t.classList.remove("hidden");const n=e.types.join(", ");d.textContent=`${e.count} map${e.count>1?"s":""} detected (${n})`}function A(e){L(),n.classList.remove("hidden"),T(e)}function T(e){c.textContent=e.tileCount.toString(),r.textContent=e.zoomLevels.length>0?`${Math.min(...e.zoomLevels)}-${Math.max(...e.zoomLevels)}`:"-",l.textContent=U(e.estimatedSize)}function C(e,t){L(),s.classList.remove("hidden"),p.style.width=`${e}%`,g.textContent=t}let M=null,x=null;function $(e){L(),o.classList.remove("hidden"),f.textContent=e,P()}async function S(){if(!E)return;i.setAttribute("disabled","true"),await async function(){try{return await chrome.permissions.contains({permissions:["debugger"]})||await chrome.permissions.request({permissions:["debugger"]})||console.log("[WebMap Archiver] permissions.request() returned false, will try attach() anyway"),!0}catch(e){return console.error("[WebMap Archiver] Permission check failed:",e),!0}}();const e=await chrome.runtime.sendMessage({type:"START_CAPTURE",tabId:E});e.success?(A({status:"recording",startedAt:(new Date).toISOString(),tileCount:0,totalRequests:0,zoomLevels:[],estimatedSize:0}),D()):$(e.error||"Failed to start capture"),i.removeAttribute("disabled")}async function z(){if(!E)return;u.setAttribute("disabled","true"),P(),C(10,"Stopping capture...");const e=await chrome.runtime.sendMessage({type:"STOP_CAPTURE",tabId:E});if(!e.success)return void $(e.error||"Failed to stop capture");C(40,"Uploading to cloud...");const t=await chrome.runtime.sendMessage({type:"PROCESS_BUNDLE",bundle:e.bundle});if(t.success)C(80,"Downloading archive..."),chrome.downloads.download({url:t.downloadUrl,filename:t.filename,saveAs:!0}),await new Promise(e=>setTimeout(e,500)),function(e,t,n){L(),a.classList.remove("hidden"),n&&(M=n,x=e);const s=t?`${t.tiles} tiles ‚Ä¢ ${U(t.size)}`:"";a.innerHTML=`\n    <p class="icon">‚úÖ</p>\n    <p><strong>Archive complete!</strong></p>\n    <p class="filename">${e}</p>\n    ${s?`<p class="stats">${s}</p>`:""}\n    <div class="actions" style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">\n      ${n?'<button id="download-btn" class="primary">‚¨áÔ∏è Download Archive</button>':""}\n      <button id="new-capture-btn" class="secondary">üì∏ New Capture</button>\n    </div>\n  `,document.getElementById("new-capture-btn")?.addEventListener("click",_),document.getElementById("download-btn")?.addEventListener("click",()=>{M&&x&&chrome.downloads.download({url:M,filename:x,saveAs:!0})})}(t.filename,{tiles:e.bundle.tiles?.length||0,size:t.size||0},t.downloadUrl);else if(t.fallbackToDownload){C(80,"Downloading capture bundle...");const t=(n=e.bundle,`${new URL(n.metadata.url).hostname.replace(/\./g,"-")}-${n.metadata.capturedAt.split("T")[0]}.webmap-capture.json`);await chrome.runtime.sendMessage({type:"DOWNLOAD_BUNDLE",bundle:e.bundle,filename:t}),function(e){L(),a.classList.remove("hidden"),y.textContent=e,a.innerHTML=`\n    <p class="icon">üì¶</p>\n    <p>Capture bundle downloaded!</p>\n    <p class="filename">${e}</p>\n    <p class="hint" style="margin-top: 8px;">\n      Cloud processing unavailable.<br>\n      Process manually with CLI:<br>\n      <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 11px;">\n        webmap-archive process &lt;file&gt;\n      </code>\n    </p>\n    <div class="actions">\n      <button id="new-capture-btn" class="secondary">üì∏ New Capture</button>\n    </div>\n  `,document.getElementById("new-capture-btn")?.addEventListener("click",_)}(t)}else $(t.error||"Processing failed");var n}async function k(){if(!E)return;P(),await chrome.runtime.sendMessage({type:"CANCEL_CAPTURE",tabId:E});const e=await chrome.runtime.sendMessage({type:"GET_TAB_STATE",tabId:E});e.maps?.count>0?I(e.maps):B()}function _(){v()}function D(){P(),w=setInterval(async()=>{if(!E)return;const e=await chrome.runtime.sendMessage({type:"GET_TAB_STATE",tabId:E});"recording"===e.capture?.status?T(e.capture):P()},500)}function P(){w&&(clearInterval(w),w=null)}function U(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]}document.addEventListener("DOMContentLoaded",v),window.addEventListener("unload",()=>{P()})})();