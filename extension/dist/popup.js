(()=>{"use strict";const e=document.getElementById("no-map"),t=document.getElementById("map-found"),n=document.getElementById("recording"),s=document.getElementById("processing"),a=document.getElementById("complete"),d=document.getElementById("error"),o=document.getElementById("map-info"),i=document.getElementById("start-capture-btn"),c=document.getElementById("tile-count"),r=document.getElementById("zoom-levels"),l=document.getElementById("data-size"),u=document.getElementById("stop-capture-btn"),m=document.getElementById("cancel-capture-btn"),p=(document.getElementById("processing-message"),document.getElementById("progress-fill")),g=document.getElementById("progress-text"),y=document.getElementById("filename"),E=document.getElementById("stats-summary"),f=document.getElementById("new-capture-btn"),b=document.getElementById("error-message"),h=document.getElementById("retry-btn");let v=null,L=null;async function w(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)return void M("Cannot access current tab");v=e.id;const t=await chrome.runtime.sendMessage({type:"GET_TAB_STATE",tabId:e.id});"recording"===t.capture?.status?(T(t.capture),D()):"processing"===t.capture?.status?x(t.capture.progress,t.capture.message):t.maps?.count>0?C(t.maps):I(),i.addEventListener("click",S),u.addEventListener("click",z),m.addEventListener("click",$),f.addEventListener("click",_),h.addEventListener("click",w)}function B(){e.classList.add("hidden"),t.classList.add("hidden"),n.classList.add("hidden"),s.classList.add("hidden"),a.classList.add("hidden"),d.classList.add("hidden")}function I(){B(),e.classList.remove("hidden")}function C(e){B(),t.classList.remove("hidden");const n=e.types.join(", ");o.textContent=`${e.count} map${e.count>1?"s":""} detected (${n})`}function T(e){B(),n.classList.remove("hidden"),A(e)}function A(e){c.textContent=e.tileCount.toString(),r.textContent=e.zoomLevels.length>0?`${Math.min(...e.zoomLevels)}-${Math.max(...e.zoomLevels)}`:"-",l.textContent=P(e.estimatedSize)}function x(e,t){B(),s.classList.remove("hidden"),p.style.width=`${e}%`,g.textContent=t}function M(e){B(),d.classList.remove("hidden"),b.textContent=e,k()}async function S(){if(!v)return;i.setAttribute("disabled","true");const e=await chrome.runtime.sendMessage({type:"START_CAPTURE",tabId:v});e.success?(T({status:"recording",startedAt:(new Date).toISOString(),tileCount:0,totalRequests:0,zoomLevels:[],estimatedSize:0}),D()):M(e.error||"Failed to start capture"),i.removeAttribute("disabled")}async function z(){if(!v)return;u.setAttribute("disabled","true"),k(),x(10,"Stopping capture...");const e=await chrome.runtime.sendMessage({type:"STOP_CAPTURE",tabId:v});if(!e.success)return void M(e.error||"Failed to stop capture");x(40,"Uploading to cloud...");const t=await chrome.runtime.sendMessage({type:"PROCESS_BUNDLE",bundle:e.bundle});if(t.success)x(80,"Downloading archive..."),chrome.downloads.download({url:t.downloadUrl,filename:t.filename,saveAs:!0}),await new Promise(e=>setTimeout(e,500)),s=t.filename,d={tiles:e.bundle.tiles?.length||0,size:t.size||0},B(),a.classList.remove("hidden"),y.textContent=s,d&&(E.textContent=`${d.tiles} tiles â€¢ ${P(d.size)}`);else if(t.fallbackToDownload){x(80,"Downloading capture bundle...");const t=(n=e.bundle,`${new URL(n.metadata.url).hostname.replace(/\./g,"-")}-${n.metadata.capturedAt.split("T")[0]}.webmap-capture.json`);await chrome.runtime.sendMessage({type:"DOWNLOAD_BUNDLE",bundle:e.bundle,filename:t}),function(e){B(),a.classList.remove("hidden"),y.textContent=e,a.innerHTML=`\n    <p class="icon">ðŸ“¦</p>\n    <p>Capture bundle downloaded!</p>\n    <p class="filename">${e}</p>\n    <p class="hint" style="margin-top: 8px;">\n      Cloud processing unavailable.<br>\n      Process manually with CLI:<br>\n      <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 11px;">\n        webmap-archive process &lt;file&gt;\n      </code>\n    </p>\n    <div class="actions">\n      <button id="new-capture-btn" class="secondary">ðŸ“¸ New Capture</button>\n    </div>\n  `,document.getElementById("new-capture-btn")?.addEventListener("click",_)}(t)}else M(t.error||"Processing failed");var n,s,d}async function $(){if(!v)return;k(),await chrome.runtime.sendMessage({type:"CANCEL_CAPTURE",tabId:v});const e=await chrome.runtime.sendMessage({type:"GET_TAB_STATE",tabId:v});e.maps?.count>0?C(e.maps):I()}function _(){w()}function D(){k(),L=setInterval(async()=>{if(!v)return;const e=await chrome.runtime.sendMessage({type:"GET_TAB_STATE",tabId:v});"recording"===e.capture?.status?A(e.capture):k()},500)}function k(){L&&(clearInterval(L),L=null)}function P(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]}document.addEventListener("DOMContentLoaded",w),window.addEventListener("unload",()=>{k()})})();