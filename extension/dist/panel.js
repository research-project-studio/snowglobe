(()=>{"use strict";!function(){let e=!1,t=0,n=[],o=0,r=0,s=new Set,i=null,a=null,c=null,l=null;const d=document.getElementById("idle-state"),u=document.getElementById("recording-state"),p=document.getElementById("processing-state"),m=document.getElementById("complete-state"),g=document.getElementById("error-state"),h=document.getElementById("map-status"),f=document.getElementById("start-btn"),y=document.getElementById("recording-duration"),v=document.getElementById("stat-tiles"),b=document.getElementById("stat-requests"),w=document.getElementById("stat-size"),I=document.getElementById("stat-zooms"),E=document.getElementById("tile-list"),x=document.getElementById("stop-btn"),C=document.getElementById("cancel-btn"),S=(document.getElementById("processing-title"),document.getElementById("processing-message")),M=document.getElementById("progress-fill"),B=document.getElementById("progress-label"),A=document.getElementById("complete-filename"),L=document.getElementById("complete-stats"),T=document.getElementById("download-btn"),W=document.getElementById("download-bundle-btn"),$=document.getElementById("new-capture-btn"),k=document.getElementById("error-message"),O=document.getElementById("retry-btn");async function D(){try{const e=await ee({type:"GET_MAPS"});if(e&&e.count>0){const t=e.maps.map(e=>e.type).join(", ");h.textContent=`${e.count} map${e.count>1?"s":""} detected (${t})`}else h.textContent="No maps detected on this page"}catch(e){h.textContent="Unable to detect maps"}}function P(e){switch(d.classList.add("hidden"),u.classList.add("hidden"),p.classList.add("hidden"),m.classList.add("hidden"),g.classList.add("hidden"),e){case"idle":d.classList.remove("hidden");break;case"recording":u.classList.remove("hidden");break;case"processing":p.classList.remove("hidden");break;case"complete":m.classList.remove("hidden");break;case"error":g.classList.remove("hidden")}}function z(){const e={reloadOnStart:!0,expandCoverage:!0,archiveMode:"standalone"};try{const t=document.getElementById("opt-reload-page"),n=document.getElementById("opt-expand-coverage"),o=document.getElementById("opt-archive-mode");return{reloadOnStart:t?.checked??e.reloadOnStart,expandCoverage:n?.checked??e.expandCoverage,archiveMode:o?.value??e.archiveMode}}catch(t){return console.warn("[WebMap Archiver] Error reading options, using defaults:",t),e}}function N(){const e=document.getElementById("options-panel"),t=document.getElementById("options-content");e&&t&&(e.classList.toggle("expanded"),t.classList.toggle("collapsed"))}async function _(){console.log("[WebMap Archiver] Starting recording...");const a=z();if(n=[],o=0,r=0,s.clear(),e=!0,t=Date.now(),v.textContent="0",b.textContent="0",w.textContent="0 B",I.textContent="-",chrome.devtools.network.onRequestFinished.addListener(j),i=setInterval(U,1e3),chrome.runtime.sendMessage({type:"CAPTURE_STARTED",tabId:chrome.devtools.inspectedWindow.tabId}),a.reloadOnStart){E.innerHTML='<p class="empty-message">Reloading page to capture all resources...</p>';try{console.log("[WebMap Archiver] Reloading page to capture initial resources..."),await chrome.devtools.inspectedWindow.reload({ignoreCache:!0}),await new Promise(e=>setTimeout(e,300))}catch(e){console.error("[WebMap Archiver] Failed to reload page:",e)}}E.innerHTML='<p class="empty-message">Pan or zoom the map to capture tiles...</p>',P("recording"),console.log("[WebMap Archiver] Recording started")}function j(t){if(!e)return;const o=t.request.url,r=t.response.content.mimeType||"",s=t.response.status,i=t.response.content.size||0;console.log(`[WebMap Archiver] Request: ${o.substring(0,80)}... (${r})`);const a=function(e){const t=[{regex:/\/(\d+)\/(\d+)\/(\d+)\.(pbf|mvt|png|jpg|jpeg|webp|avif)/,groups:[1,2,3]},{regex:/\/tiles\/(\d+)\/(\d+)\/(\d+)/,groups:[1,2,3]},{regex:/[?&]z=(\d+)&x=(\d+)&y=(\d+)/,groups:[1,2,3]},{regex:/\/(\d{1,2})\/(\d+)\/(\d+)(?:\.|\/|$|\?)/,groups:[1,2,3]}];for(const{regex:n,groups:o}of t){const t=e.match(n);if(t){const n=parseInt(t[o[0]]),r=parseInt(t[o[1]]),s=parseInt(t[o[2]]);if(n<0||n>22)continue;try{const t=new URL(e).hostname.split(".");let o=t[0];return("api"===o||"tiles"===o)&&t.length>1&&(o=t[1]),{coords:{z:n,x:r,y:s},source:o||"tiles"}}catch{return{coords:{z:n,x:r,y:s},source:"tiles"}}}}return null}(o),c=function(e){return Y.some(t=>t.test(e))}(o),l=function(e){return Z.some(t=>t.test(e))}(o),d={url:o,method:t.request.method,status:s,mimeType:r,size:i,isTile:null!==a,tileCoords:a?.coords,tileSource:a?.source,isSprite:c,spriteInfo:c?Q(o):void 0,isGlyph:l,glyphInfo:l?X(o):void 0};(null!==a||c||l||r.includes("json")||r.includes("pbf")||r.includes("protobuf")||o.includes("style"))&&i<10485760?t.getContent((e,t)=>{e&&(d.body="base64"===t?e:btoa(e)),n.push(d),R(d)}):(n.push(d),R(d))}function R(e){if(b.textContent=n.length.toString(),r+=e.size,w.textContent=te(r),e.isTile&&e.tileCoords){o++,v.textContent=o.toString(),s.add(e.tileCoords.z);const t=Array.from(s).sort((e,t)=>e-t);I.textContent=t.length>0?`${t[0]}-${t[t.length-1]}`:"-",function(e){const t=E.querySelector(".empty-message");t&&t.remove();const n=document.createElement("div");for(n.className="tile-item new",n.textContent=`z${e.tileCoords.z}/${e.tileCoords.x}/${e.tileCoords.y} (${e.tileSource})`,E.insertBefore(n,E.firstChild);E.children.length>20;)E.removeChild(E.lastChild)}(e),console.log(`[WebMap Archiver] âœ… Tile captured: z${e.tileCoords.z}/${e.tileCoords.x}/${e.tileCoords.y}`)}chrome.runtime.sendMessage({type:"CAPTURE_STATS_UPDATE",tabId:chrome.devtools.inspectedWindow.tabId,stats:{tileCount:o,totalRequests:n.length,estimatedSize:r,zoomLevels:Array.from(s)}})}function U(){const e=Math.floor((Date.now()-t)/1e3),n=Math.floor(e/60),o=e%60;y.textContent=`${n}:${o.toString().padStart(2,"0")}`}async function q(){console.log("[WebMap Archiver] Stopping recording..."),e=!1,chrome.devtools.network.onRequestFinished.removeListener(j),i&&(clearInterval(i),i=null),P("processing"),G(10,"Extracting map style...");try{const e=await ee({type:"CAPTURE_STYLE"}),t=await new Promise(e=>{chrome.devtools.inspectedWindow.eval("({ url: window.location.href, title: document.title })",(t,n)=>{if(n)console.error("[WebMap Archiver] Failed to get page info:",n),chrome.devtools.inspectedWindow.eval("window.location.href",t=>{e({url:t||"https://unknown",title:"Unknown Page"})});else if(t&&"object"==typeof t){const n=t;e({url:n.url||"https://unknown",title:n.title||"Unknown Page"})}else e({url:"https://unknown",title:"Unknown Page"})})});console.log("[WebMap Archiver] Page info:",t),t.url&&"https://unknown"!==t.url||console.error("[WebMap Archiver] Could not determine page URL"),G(20,"Extracting GeoJSON sources..."),e&&e.style&&(e.style=await async function(e){if(!e||!e.sources)return e;console.log("[WebMap Archiver] Extracting GeoJSON sources...");const t=Object.entries(e.sources).filter(([,e])=>"geojson"===e.type).map(([e])=>e);if(0===t.length)return console.log("[WebMap Archiver] No GeoJSON sources found"),e;console.log(`[WebMap Archiver] Found ${t.length} GeoJSON sources: ${t.join(", ")}`);const n=`\n      (function() {\n        try {\n          // Find the map instance\n          const container = document.querySelector('.maplibregl-map, .mapboxgl-map');\n          if (!container) {\n            return { error: 'No map container found' };\n          }\n\n          const map = container.__maplibregl || container._map || container.__mapboxgl ||\n                      window.map || window.maplibreMap || window.mapboxMap;\n          if (!map || typeof map.querySourceFeatures !== 'function') {\n            return { error: 'No map instance found' };\n          }\n\n          const style = map.getStyle();\n          if (!style || !style.sources) {\n            return { error: 'Could not get style' };\n          }\n\n          const geojsonSourceIds = ${JSON.stringify(t)};\n          const extractedData = {};\n\n          for (const sourceId of geojsonSourceIds) {\n            try {\n              const features = map.querySourceFeatures(sourceId);\n\n              if (!features || features.length === 0) {\n                console.warn('[WebMap Archiver] No features found in source ' + sourceId);\n\n                // Try _data fallback\n                const source = map.getSource(sourceId);\n                if (source && source._data) {\n                  extractedData[sourceId] = source._data;\n                  continue;\n                }\n\n                continue;\n              }\n\n              console.log('[WebMap Archiver] Extracted ' + features.length + ' features from ' + sourceId);\n\n              // Deduplicate features by ID or geometry\n              const seen = new Map();\n              const unique = [];\n              for (const f of features) {\n                const key = f.id !== undefined ? f.id : JSON.stringify(f.geometry);\n                if (!seen.has(key)) {\n                  seen.set(key, true);\n                  unique.push({\n                    type: 'Feature',\n                    geometry: f.geometry,\n                    properties: f.properties || {},\n                    ...(f.id !== undefined && { id: f.id }),\n                  });\n                }\n              }\n\n              extractedData[sourceId] = {\n                type: 'FeatureCollection',\n                features: unique,\n              };\n\n              console.log('[WebMap Archiver] Injected ' + unique.length + ' unique features into ' + sourceId);\n\n            } catch (e) {\n              console.error('[WebMap Archiver] Error extracting ' + sourceId + ':', e);\n            }\n          }\n\n          return { extractedData };\n\n        } catch (e) {\n          return { error: 'Extraction failed: ' + e.message };\n        }\n      })();\n    `;return new Promise(t=>{chrome.devtools.inspectedWindow.eval(n,(n,o)=>{if(o)return console.error("[WebMap Archiver] GeoJSON extraction error:",o),void t(e);if(n&&n.error)return console.error("[WebMap Archiver] GeoJSON extraction failed:",n.error),void t(e);if(n&&n.extractedData)for(const[t,o]of Object.entries(n.extractedData))if(e.sources[t]){e.sources[t].data=o;const n=JSON.stringify(o).length/1048576,r=o.features?.length||0;console.log(`[WebMap Archiver] GeoJSON '${t}': ${n.toFixed(2)}MB, ${r} features`),n>5&&console.warn(`[WebMap Archiver] Large GeoJSON source '${t}': ${n.toFixed(1)}MB`)}t(e)})})}(e.style)),G(30,"Building capture bundle...");const o=function(e,t){const o=z(),r=n.filter(e=>e.isTile&&e.body&&e.tileCoords).map(e=>({z:e.tileCoords.z,x:e.tileCoords.x,y:e.tileCoords.y,sourceId:e.tileSource||"tiles",url:e.url,data:e.body,format:e.mimeType.includes("png")?"png":e.mimeType.includes("jpg")||e.mimeType.includes("jpeg")?"jpg":e.mimeType.includes("webp")?"webp":"pbf"})),s=n.filter(e=>(e.isSprite||e.isGlyph)&&e.body).map(e=>{if(e.isSprite&&e.spriteInfo)return{resourceType:"sprite",url:e.url,data:e.body,variant:e.spriteInfo.variant,contentType:e.spriteInfo.contentType};if(e.isGlyph&&e.glyphInfo){const[t,n]=e.glyphInfo.range.split("-").map(e=>parseInt(e));return{resourceType:"glyph",url:e.url,data:e.body,fontStack:e.glyphInfo.fontStack,rangeStart:t,rangeEnd:n}}return null}).filter(e=>null!==e);console.log(`[WebMap Archiver] Bundle resources: ${s.length} (${s.filter(e=>"sprite"===e.resourceType).length} sprites, ${s.filter(e=>"glyph"===e.resourceType).length} glyphs)`);const i={log:{version:"1.2",creator:{name:"WebMap Archiver",version:"0.3.2"},entries:n.map(e=>({startedDateTime:(new Date).toISOString(),request:{method:e.method,url:e.url,headers:[]},response:{status:e.status,statusText:200===e.status?"OK":"Error",headers:[],content:{size:e.size,mimeType:e.mimeType,text:e.body,encoding:e.body?"base64":void 0}},timings:{wait:0,receive:0}}))}};let a={center:[0,0],zoom:10};if(e?.viewport){const t=e.viewport;a={center:[t.center?.lng??t.center?.[0]??0,t.center?.lat??t.center?.[1]??0],zoom:t.zoom??10,bearing:t.bearing??0,pitch:t.pitch??0},t.bounds&&(a.bounds=[[t.bounds._sw?.lng??t.bounds[0]?.[0],t.bounds._sw?.lat??t.bounds[0]?.[1]],[t.bounds._ne?.lng??t.bounds[1]?.[0],t.bounds._ne?.lat??t.bounds[1]?.[1]]])}return{version:"1.0",metadata:{url:t.url,title:t.title,capturedAt:(new Date).toISOString(),userAgent:navigator.userAgent,mapLibrary:e?.mapLibrary?{type:e.mapLibrary.type||"unknown",version:e.mapLibrary.version}:void 0},viewport:a,style:e?.style||null,har:i,tiles:r,resources:s,options:{expandCoverage:o.expandCoverage,archiveMode:o.archiveMode}}}(e,t);a=o,console.log("[WebMap Archiver] Bundle built:",{tiles:o.tiles?.length||0,harEntries:o.har?.log?.entries?.length||0,hasStyle:!!o.style}),console.log("[WebMap Archiver] Bundle being sent to Modal:"),console.log(JSON.stringify(o,null,2).substring(0,2e3)),console.log("[WebMap Archiver] Bundle stats:",{version:o.version,hasMetadata:!!o.metadata,metadataUrl:o.metadata?.url,metadataCapturedAt:o.metadata?.capturedAt,hasViewport:!!o.viewport,viewportCenter:o.viewport?.center,viewportZoom:o.viewport?.zoom,tilesCount:o.tiles?.length,tilesFirstItem:o.tiles?.[0],hasHar:!!o.har,harEntriesCount:o.har?.log?.entries?.length}),G(50,"Uploading to cloud...");const s=await chrome.runtime.sendMessage({type:"PROCESS_BUNDLE",bundle:o});if(s.success)G(90,"Preparing download..."),c=s.downloadUrl,l=s.filename,chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),J(s.filename,o.tiles?.length||0,s.size||0);else{if(!s.fallbackToDownload)throw new Error(s.error||"Processing failed");l=function(e){try{return`${new URL(e).hostname.replace(/\./g,"-")}-${(new Date).toISOString().split("T")[0]}.webmap-capture.json`}catch{return`webmap-${Date.now()}.webmap-capture.json`}}(t.url),chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),J(l,o.tiles?.length||0,r,!0)}}catch(e){console.error("[WebMap Archiver] Error:",e),t=String(e),k.textContent=t,P("error")}var t}function F(){e=!1,chrome.devtools.network.onRequestFinished.removeListener(j),i&&(clearInterval(i),i=null),chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),H()}function G(e,t){M.style.width=`${e}%`,B.textContent=`${e}%`,S.textContent=t}function J(e,t,n,o=!1){A.textContent=e,L.textContent=`${t} tiles â€¢ ${te(n)}`,o?(T.textContent="ðŸ“¦ Download Capture Bundle",T.onclick=V,W.classList.add("hidden")):(T.textContent="â¬‡ï¸ Download Archive",T.onclick=K,W.classList.remove("hidden")),P("complete")}function H(){n=[],o=0,r=0,s.clear(),a=null,c=null,l=null,D(),P("idle")}function K(){c&&l&&chrome.runtime.sendMessage({type:"DOWNLOAD_FILE",url:c,filename:l})}function V(){if(a&&l){const e=l.replace(".zip",".webmap-capture.json");chrome.runtime.sendMessage({type:"DOWNLOAD_BUNDLE",bundle:a,filename:e})}}const Y=[/\/sprite(@\dx)?\.(png|json)(\?|$)/i,/\/sprites?\//i],Z=[/\/fonts\/[^/]+\/\d+-\d+\.pbf/i,/\/glyphs?\//i];function Q(e){const t=e.match(/\/(sprite(@\dx)?\.(png|json))(\?|$)/i),n=t?t[1]:"sprite.png",o=t&&t[2]?t[2].substring(1):"1x",r=n.endsWith(".json")?"json":"image";return{filename:n,variant:o,contentType:r}}function X(e){const t=e.match(/\/fonts\/([^/]+)\/(\d+-\d+)\.pbf/i);return t?{fontStack:decodeURIComponent(t[1]),range:t[2]}:{fontStack:"unknown",range:"0-255"}}function ee(e){return new Promise(t=>{chrome.devtools.inspectedWindow.eval(`(() => {\n        return new Promise((resolve) => {\n          chrome.runtime.sendMessage(${JSON.stringify(e)}, resolve);\n        });\n      })()`,(e,n)=>{n?(console.error("Content script error:",n),t(null)):t(e)})})}function te(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]}document.addEventListener("DOMContentLoaded",function(){!function(){f.addEventListener("click",_),x.addEventListener("click",q),C.addEventListener("click",F),W.addEventListener("click",V),$.addEventListener("click",H),O.addEventListener("click",H);const e=document.getElementById("options-header");e&&e.addEventListener("click",N)}(),D(),P("idle")})}()})();