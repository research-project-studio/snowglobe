(()=>{"use strict";!function(){let e=!1,t=0,n=[],o=0,s=0,r=new Set,i=null,l=null,d=null,a=null;const c=document.getElementById("idle-state"),u=document.getElementById("recording-state"),m=document.getElementById("processing-state"),p=document.getElementById("complete-state"),g=document.getElementById("error-state"),h=document.getElementById("map-status"),y=document.getElementById("start-btn"),b=document.getElementById("recording-duration"),v=document.getElementById("stat-tiles"),w=document.getElementById("stat-requests"),f=document.getElementById("stat-size"),E=document.getElementById("stat-zooms"),C=document.getElementById("tile-list"),I=document.getElementById("stop-btn"),B=document.getElementById("cancel-btn"),L=(document.getElementById("processing-title"),document.getElementById("processing-message")),x=document.getElementById("progress-fill"),M=document.getElementById("progress-label"),A=document.getElementById("complete-filename"),T=document.getElementById("complete-stats"),S=document.getElementById("download-btn"),z=document.getElementById("download-bundle-btn"),k=document.getElementById("new-capture-btn"),P=document.getElementById("error-message"),$=document.getElementById("retry-btn");async function W(){try{const e=await K({type:"GET_MAPS"});if(e&&e.count>0){const t=e.maps.map(e=>e.type).join(", ");h.textContent=`${e.count} map${e.count>1?"s":""} detected (${t})`}else h.textContent="No maps detected on this page"}catch(e){h.textContent="Unable to detect maps"}}function D(e){switch(c.classList.add("hidden"),u.classList.add("hidden"),m.classList.add("hidden"),p.classList.add("hidden"),g.classList.add("hidden"),e){case"idle":c.classList.remove("hidden");break;case"recording":u.classList.remove("hidden");break;case"processing":m.classList.remove("hidden");break;case"complete":p.classList.remove("hidden");break;case"error":g.classList.remove("hidden")}}function U(){console.log("[WebMap Archiver] Starting recording..."),e=!0,t=Date.now(),n=[],o=0,s=0,r.clear(),v.textContent="0",w.textContent="0",f.textContent="0 B",E.textContent="-",C.innerHTML='<p class="empty-message">Pan or zoom the map to capture tiles...</p>',chrome.devtools.network.onRequestFinished.addListener(R),i=setInterval(_,1e3),chrome.runtime.sendMessage({type:"CAPTURE_STARTED",tabId:chrome.devtools.inspectedWindow.tabId}),D("recording"),console.log("[WebMap Archiver] Recording started")}function R(t){if(!e)return;const o=t.request.url,s=t.response.content.mimeType||"",r=t.response.status,i=t.response.content.size||0;console.log(`[WebMap Archiver] Request: ${o.substring(0,80)}... (${s})`);const l=function(e){const t=[{regex:/\/(\d+)\/(\d+)\/(\d+)\.(pbf|mvt|png|jpg|jpeg|webp|avif)/,groups:[1,2,3]},{regex:/\/tiles\/(\d+)\/(\d+)\/(\d+)/,groups:[1,2,3]},{regex:/[?&]z=(\d+)&x=(\d+)&y=(\d+)/,groups:[1,2,3]},{regex:/\/(\d{1,2})\/(\d+)\/(\d+)(?:\.|\/|$|\?)/,groups:[1,2,3]}];for(const{regex:n,groups:o}of t){const t=e.match(n);if(t){const n=parseInt(t[o[0]]),s=parseInt(t[o[1]]),r=parseInt(t[o[2]]);if(n<0||n>22)continue;try{const t=new URL(e).hostname.split(".");let o=t[0];return("api"===o||"tiles"===o)&&t.length>1&&(o=t[1]),{coords:{z:n,x:s,y:r},source:o||"tiles"}}catch{return{coords:{z:n,x:s,y:r},source:"tiles"}}}}return null}(o),d={url:o,method:t.request.method,status:r,mimeType:s,size:i,isTile:null!==l,tileCoords:l?.coords,tileSource:l?.source};(null!==l||s.includes("json")||s.includes("pbf")||s.includes("protobuf")||o.includes("sprite")||o.includes("glyphs")||o.includes("style"))&&i<10485760?t.getContent((e,t)=>{e&&(d.body="base64"===t?e:btoa(e)),n.push(d),O(d)}):(n.push(d),O(d))}function O(e){if(w.textContent=n.length.toString(),s+=e.size,f.textContent=V(s),e.isTile&&e.tileCoords){o++,v.textContent=o.toString(),r.add(e.tileCoords.z);const t=Array.from(r).sort((e,t)=>e-t);E.textContent=t.length>0?`${t[0]}-${t[t.length-1]}`:"-",function(e){const t=C.querySelector(".empty-message");t&&t.remove();const n=document.createElement("div");for(n.className="tile-item new",n.textContent=`z${e.tileCoords.z}/${e.tileCoords.x}/${e.tileCoords.y} (${e.tileSource})`,C.insertBefore(n,C.firstChild);C.children.length>20;)C.removeChild(C.lastChild)}(e),console.log(`[WebMap Archiver] âœ… Tile captured: z${e.tileCoords.z}/${e.tileCoords.x}/${e.tileCoords.y}`)}chrome.runtime.sendMessage({type:"CAPTURE_STATS_UPDATE",tabId:chrome.devtools.inspectedWindow.tabId,stats:{tileCount:o,totalRequests:n.length,estimatedSize:s,zoomLevels:Array.from(r)}})}function _(){const e=Math.floor((Date.now()-t)/1e3),n=Math.floor(e/60),o=e%60;b.textContent=`${n}:${o.toString().padStart(2,"0")}`}async function j(){console.log("[WebMap Archiver] Stopping recording..."),e=!1,chrome.devtools.network.onRequestFinished.removeListener(R),i&&(clearInterval(i),i=null),D("processing"),F(10,"Extracting map style...");try{const e=await K({type:"CAPTURE_STYLE"}),t=await new Promise(e=>{chrome.devtools.inspectedWindow.eval("({ url: window.location.href, title: document.title })",(t,n)=>{if(n)console.error("[WebMap Archiver] Failed to get page info:",n),chrome.devtools.inspectedWindow.eval("window.location.href",t=>{e({url:t||"https://unknown",title:"Unknown Page"})});else if(t&&"object"==typeof t){const n=t;e({url:n.url||"https://unknown",title:n.title||"Unknown Page"})}else e({url:"https://unknown",title:"Unknown Page"})})});console.log("[WebMap Archiver] Page info:",t),t.url&&"https://unknown"!==t.url||console.error("[WebMap Archiver] Could not determine page URL"),F(30,"Building capture bundle...");const o=function(e,t){const o=n.filter(e=>e.isTile&&e.body&&e.tileCoords).map(e=>({z:e.tileCoords.z,x:e.tileCoords.x,y:e.tileCoords.y,sourceId:e.tileSource||"tiles",url:e.url,data:e.body,format:e.mimeType.includes("png")?"png":e.mimeType.includes("jpg")||e.mimeType.includes("jpeg")?"jpg":e.mimeType.includes("webp")?"webp":"pbf"})),s={log:{version:"1.2",creator:{name:"WebMap Archiver",version:"0.2.0"},entries:n.map(e=>({startedDateTime:(new Date).toISOString(),request:{method:e.method,url:e.url,headers:[]},response:{status:e.status,statusText:200===e.status?"OK":"Error",headers:[],content:{size:e.size,mimeType:e.mimeType,text:e.body,encoding:e.body?"base64":void 0}},timings:{wait:0,receive:0}}))}};let r={center:[0,0],zoom:10};if(e?.viewport){const t=e.viewport;r={center:[t.center?.lng??t.center?.[0]??0,t.center?.lat??t.center?.[1]??0],zoom:t.zoom??10,bearing:t.bearing??0,pitch:t.pitch??0},t.bounds&&(r.bounds=[[t.bounds._sw?.lng??t.bounds[0]?.[0],t.bounds._sw?.lat??t.bounds[0]?.[1]],[t.bounds._ne?.lng??t.bounds[1]?.[0],t.bounds._ne?.lat??t.bounds[1]?.[1]]])}return{version:"1.0",metadata:{url:t.url,title:t.title,capturedAt:(new Date).toISOString(),userAgent:navigator.userAgent,mapLibrary:e?.mapLibrary?{type:e.mapLibrary.type||"unknown",version:e.mapLibrary.version}:void 0},viewport:r,style:e?.style||null,har:s,tiles:o}}(e,t);l=o,console.log("[WebMap Archiver] Bundle built:",{tiles:o.tiles?.length||0,harEntries:o.har?.log?.entries?.length||0,hasStyle:!!o.style}),console.log("[WebMap Archiver] Bundle being sent to Modal:"),console.log(JSON.stringify(o,null,2).substring(0,2e3)),console.log("[WebMap Archiver] Bundle stats:",{version:o.version,hasMetadata:!!o.metadata,metadataUrl:o.metadata?.url,metadataCapturedAt:o.metadata?.capturedAt,hasViewport:!!o.viewport,viewportCenter:o.viewport?.center,viewportZoom:o.viewport?.zoom,tilesCount:o.tiles?.length,tilesFirstItem:o.tiles?.[0],hasHar:!!o.har,harEntriesCount:o.har?.log?.entries?.length}),F(50,"Uploading to cloud...");const r=await chrome.runtime.sendMessage({type:"PROCESS_BUNDLE",bundle:o});if(r.success)F(90,"Preparing download..."),d=r.downloadUrl,a=r.filename,chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),N(r.filename,o.tiles?.length||0,r.size||0);else{if(!r.fallbackToDownload)throw new Error(r.error||"Processing failed");a=function(e){try{return`${new URL(e).hostname.replace(/\./g,"-")}-${(new Date).toISOString().split("T")[0]}.webmap-capture.json`}catch{return`webmap-${Date.now()}.webmap-capture.json`}}(t.url),chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),N(a,o.tiles?.length||0,s,!0)}}catch(e){console.error("[WebMap Archiver] Error:",e),t=String(e),P.textContent=t,D("error")}var t}function q(){e=!1,chrome.devtools.network.onRequestFinished.removeListener(R),i&&(clearInterval(i),i=null),chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),G()}function F(e,t){x.style.width=`${e}%`,M.textContent=`${e}%`,L.textContent=t}function N(e,t,n,o=!1){A.textContent=e,T.textContent=`${t} tiles â€¢ ${V(n)}`,o?(S.textContent="ðŸ“¦ Download Capture Bundle",S.onclick=J,z.classList.add("hidden")):(S.textContent="â¬‡ï¸ Download Archive",S.onclick=H,z.classList.remove("hidden")),D("complete")}function G(){n=[],o=0,s=0,r.clear(),l=null,d=null,a=null,W(),D("idle")}function H(){d&&a&&chrome.runtime.sendMessage({type:"DOWNLOAD_FILE",url:d,filename:a})}function J(){if(l&&a){const e=a.replace(".zip",".webmap-capture.json");chrome.runtime.sendMessage({type:"DOWNLOAD_BUNDLE",bundle:l,filename:e})}}function K(e){return new Promise(t=>{chrome.devtools.inspectedWindow.eval(`(() => {\n        return new Promise((resolve) => {\n          chrome.runtime.sendMessage(${JSON.stringify(e)}, resolve);\n        });\n      })()`,(e,n)=>{n?(console.error("Content script error:",n),t(null)):t(e)})})}function V(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]}document.addEventListener("DOMContentLoaded",function(){y.addEventListener("click",U),I.addEventListener("click",j),B.addEventListener("click",q),S.addEventListener("click",H),z.addEventListener("click",J),k.addEventListener("click",G),$.addEventListener("click",G),W(),D("idle")})}()})();