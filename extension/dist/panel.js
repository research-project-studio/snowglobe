(()=>{"use strict";!function(){let e=!1,t=0,n=[],o=0,r=0,s=new Set,i=null,l=null,a=null,d=null;const c=document.getElementById("idle-state"),u=document.getElementById("recording-state"),p=document.getElementById("processing-state"),m=document.getElementById("complete-state"),g=document.getElementById("error-state"),h=document.getElementById("map-status"),y=document.getElementById("start-btn"),v=document.getElementById("recording-duration"),f=document.getElementById("stat-tiles"),b=document.getElementById("stat-requests"),w=document.getElementById("stat-size"),E=document.getElementById("stat-zooms"),I=document.getElementById("tile-list"),C=document.getElementById("stop-btn"),B=document.getElementById("cancel-btn"),x=(document.getElementById("processing-title"),document.getElementById("processing-message")),M=document.getElementById("progress-fill"),S=document.getElementById("progress-label"),L=document.getElementById("complete-filename"),T=document.getElementById("complete-stats"),A=document.getElementById("download-btn"),k=document.getElementById("download-bundle-btn"),$=document.getElementById("new-capture-btn"),W=document.getElementById("error-message"),z=document.getElementById("retry-btn");async function P(){try{const e=await ee({type:"GET_MAPS"});if(e&&e.count>0){const t=e.maps.map(e=>e.type).join(", ");h.textContent=`${e.count} map${e.count>1?"s":""} detected (${t})`}else h.textContent="No maps detected on this page"}catch(e){h.textContent="Unable to detect maps"}}function D(e){switch(c.classList.add("hidden"),u.classList.add("hidden"),p.classList.add("hidden"),m.classList.add("hidden"),g.classList.add("hidden"),e){case"idle":c.classList.remove("hidden");break;case"recording":u.classList.remove("hidden");break;case"processing":p.classList.remove("hidden");break;case"complete":m.classList.remove("hidden");break;case"error":g.classList.remove("hidden")}}function R(){const e={reloadOnStart:!0,expandCoverage:!0,archiveMode:"standalone"};try{const t=document.getElementById("opt-reload-page"),n=document.getElementById("opt-expand-coverage"),o=document.getElementById("opt-archive-mode");return{reloadOnStart:t?.checked??e.reloadOnStart,expandCoverage:n?.checked??e.expandCoverage,archiveMode:o?.value??e.archiveMode}}catch(t){return console.warn("[WebMap Archiver] Error reading options, using defaults:",t),e}}function U(){const e=document.getElementById("options-panel"),t=document.getElementById("options-content");e&&t&&(e.classList.toggle("expanded"),t.classList.toggle("collapsed"))}async function O(){console.log("[WebMap Archiver] Starting recording...");const l=R();if(n=[],o=0,r=0,s.clear(),e=!0,t=Date.now(),f.textContent="0",b.textContent="0",w.textContent="0 B",E.textContent="-",chrome.devtools.network.onRequestFinished.addListener(j),i=setInterval(q,1e3),chrome.runtime.sendMessage({type:"CAPTURE_STARTED",tabId:chrome.devtools.inspectedWindow.tabId}),l.reloadOnStart){I.innerHTML='<p class="empty-message">Reloading page to capture all resources...</p>';try{console.log("[WebMap Archiver] Reloading page to capture initial resources..."),await chrome.devtools.inspectedWindow.reload({ignoreCache:!0}),await new Promise(e=>setTimeout(e,300))}catch(e){console.error("[WebMap Archiver] Failed to reload page:",e)}}I.innerHTML='<p class="empty-message">Pan or zoom the map to capture tiles...</p>',D("recording"),console.log("[WebMap Archiver] Recording started")}function j(t){if(!e)return;const o=t.request.url,r=t.response.content.mimeType||"",s=t.response.status,i=t.response.content.size||0;console.log(`[WebMap Archiver] Request: ${o.substring(0,80)}... (${r})`);const l=function(e){const t=[{regex:/\/(\d+)\/(\d+)\/(\d+)\.(pbf|mvt|png|jpg|jpeg|webp|avif)/,groups:[1,2,3]},{regex:/\/tiles\/(\d+)\/(\d+)\/(\d+)/,groups:[1,2,3]},{regex:/[?&]z=(\d+)&x=(\d+)&y=(\d+)/,groups:[1,2,3]},{regex:/\/(\d{1,2})\/(\d+)\/(\d+)(?:\.|\/|$|\?)/,groups:[1,2,3]}];for(const{regex:n,groups:o}of t){const t=e.match(n);if(t){const n=parseInt(t[o[0]]),r=parseInt(t[o[1]]),s=parseInt(t[o[2]]);if(n<0||n>22)continue;try{const t=new URL(e).hostname.split(".");let o=t[0];return("api"===o||"tiles"===o)&&t.length>1&&(o=t[1]),{coords:{z:n,x:r,y:s},source:o||"tiles"}}catch{return{coords:{z:n,x:r,y:s},source:"tiles"}}}}return null}(o),a=function(e){return Y.some(t=>t.test(e))}(o),d=function(e){return Z.some(t=>t.test(e))}(o),c={url:o,method:t.request.method,status:s,mimeType:r,size:i,isTile:null!==l,tileCoords:l?.coords,tileSource:l?.source,isSprite:a,spriteInfo:a?Q(o):void 0,isGlyph:d,glyphInfo:d?X(o):void 0};(null!==l||a||d||r.includes("json")||r.includes("pbf")||r.includes("protobuf")||o.includes("style"))&&i<10485760?t.getContent((e,t)=>{e&&(c.body="base64"===t?e:btoa(e)),n.push(c),_(c)}):(n.push(c),_(c))}function _(e){if(b.textContent=n.length.toString(),r+=e.size,w.textContent=te(r),e.isTile&&e.tileCoords){o++,f.textContent=o.toString(),s.add(e.tileCoords.z);const t=Array.from(s).sort((e,t)=>e-t);E.textContent=t.length>0?`${t[0]}-${t[t.length-1]}`:"-",function(e){const t=I.querySelector(".empty-message");t&&t.remove();const n=document.createElement("div");for(n.className="tile-item new",n.textContent=`z${e.tileCoords.z}/${e.tileCoords.x}/${e.tileCoords.y} (${e.tileSource})`,I.insertBefore(n,I.firstChild);I.children.length>20;)I.removeChild(I.lastChild)}(e),console.log(`[WebMap Archiver] âœ… Tile captured: z${e.tileCoords.z}/${e.tileCoords.x}/${e.tileCoords.y}`)}chrome.runtime.sendMessage({type:"CAPTURE_STATS_UPDATE",tabId:chrome.devtools.inspectedWindow.tabId,stats:{tileCount:o,totalRequests:n.length,estimatedSize:r,zoomLevels:Array.from(s)}})}function q(){const e=Math.floor((Date.now()-t)/1e3),n=Math.floor(e/60),o=e%60;v.textContent=`${n}:${o.toString().padStart(2,"0")}`}async function F(){console.log("[WebMap Archiver] Stopping recording..."),e=!1,chrome.devtools.network.onRequestFinished.removeListener(j),i&&(clearInterval(i),i=null),D("processing"),G(10,"Extracting map style...");try{const e=await ee({type:"CAPTURE_STYLE"}),t=await new Promise(e=>{chrome.devtools.inspectedWindow.eval("({ url: window.location.href, title: document.title })",(t,n)=>{if(n)console.error("[WebMap Archiver] Failed to get page info:",n),chrome.devtools.inspectedWindow.eval("window.location.href",t=>{e({url:t||"https://unknown",title:"Unknown Page"})});else if(t&&"object"==typeof t){const n=t;e({url:n.url||"https://unknown",title:n.title||"Unknown Page"})}else e({url:"https://unknown",title:"Unknown Page"})})});console.log("[WebMap Archiver] Page info:",t),t.url&&"https://unknown"!==t.url||console.error("[WebMap Archiver] Could not determine page URL"),G(30,"Building capture bundle...");const o=function(e,t){const o=R(),r=n.filter(e=>e.isTile&&e.body&&e.tileCoords).map(e=>({z:e.tileCoords.z,x:e.tileCoords.x,y:e.tileCoords.y,sourceId:e.tileSource||"tiles",url:e.url,data:e.body,format:e.mimeType.includes("png")?"png":e.mimeType.includes("jpg")||e.mimeType.includes("jpeg")?"jpg":e.mimeType.includes("webp")?"webp":"pbf"})),s=n.filter(e=>(e.isSprite||e.isGlyph)&&e.body).map(e=>{if(e.isSprite&&e.spriteInfo)return{resourceType:"sprite",url:e.url,data:e.body,variant:e.spriteInfo.variant,contentType:e.spriteInfo.contentType};if(e.isGlyph&&e.glyphInfo){const[t,n]=e.glyphInfo.range.split("-").map(e=>parseInt(e));return{resourceType:"glyph",url:e.url,data:e.body,fontStack:e.glyphInfo.fontStack,rangeStart:t,rangeEnd:n}}return null}).filter(e=>null!==e);console.log(`[WebMap Archiver] Bundle resources: ${s.length} (${s.filter(e=>"sprite"===e.resourceType).length} sprites, ${s.filter(e=>"glyph"===e.resourceType).length} glyphs)`);const i={log:{version:"1.2",creator:{name:"WebMap Archiver",version:"0.3.2"},entries:n.map(e=>({startedDateTime:(new Date).toISOString(),request:{method:e.method,url:e.url,headers:[]},response:{status:e.status,statusText:200===e.status?"OK":"Error",headers:[],content:{size:e.size,mimeType:e.mimeType,text:e.body,encoding:e.body?"base64":void 0}},timings:{wait:0,receive:0}}))}};let l={center:[0,0],zoom:10};if(e?.viewport){const t=e.viewport;l={center:[t.center?.lng??t.center?.[0]??0,t.center?.lat??t.center?.[1]??0],zoom:t.zoom??10,bearing:t.bearing??0,pitch:t.pitch??0},t.bounds&&(l.bounds=[[t.bounds._sw?.lng??t.bounds[0]?.[0],t.bounds._sw?.lat??t.bounds[0]?.[1]],[t.bounds._ne?.lng??t.bounds[1]?.[0],t.bounds._ne?.lat??t.bounds[1]?.[1]]])}return{version:"1.0",metadata:{url:t.url,title:t.title,capturedAt:(new Date).toISOString(),userAgent:navigator.userAgent,mapLibrary:e?.mapLibrary?{type:e.mapLibrary.type||"unknown",version:e.mapLibrary.version}:void 0},viewport:l,style:e?.style||null,har:i,tiles:r,resources:s,options:{expandCoverage:o.expandCoverage,archiveMode:o.archiveMode}}}(e,t);l=o,console.log("[WebMap Archiver] Bundle built:",{tiles:o.tiles?.length||0,harEntries:o.har?.log?.entries?.length||0,hasStyle:!!o.style}),console.log("[WebMap Archiver] Bundle being sent to Modal:"),console.log(JSON.stringify(o,null,2).substring(0,2e3)),console.log("[WebMap Archiver] Bundle stats:",{version:o.version,hasMetadata:!!o.metadata,metadataUrl:o.metadata?.url,metadataCapturedAt:o.metadata?.capturedAt,hasViewport:!!o.viewport,viewportCenter:o.viewport?.center,viewportZoom:o.viewport?.zoom,tilesCount:o.tiles?.length,tilesFirstItem:o.tiles?.[0],hasHar:!!o.har,harEntriesCount:o.har?.log?.entries?.length}),G(50,"Uploading to cloud...");const s=await chrome.runtime.sendMessage({type:"PROCESS_BUNDLE",bundle:o});if(s.success)G(90,"Preparing download..."),a=s.downloadUrl,d=s.filename,chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),H(s.filename,o.tiles?.length||0,s.size||0);else{if(!s.fallbackToDownload)throw new Error(s.error||"Processing failed");d=function(e){try{return`${new URL(e).hostname.replace(/\./g,"-")}-${(new Date).toISOString().split("T")[0]}.webmap-capture.json`}catch{return`webmap-${Date.now()}.webmap-capture.json`}}(t.url),chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),H(d,o.tiles?.length||0,r,!0)}}catch(e){console.error("[WebMap Archiver] Error:",e),t=String(e),W.textContent=t,D("error")}var t}function N(){e=!1,chrome.devtools.network.onRequestFinished.removeListener(j),i&&(clearInterval(i),i=null),chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),J()}function G(e,t){M.style.width=`${e}%`,S.textContent=`${e}%`,x.textContent=t}function H(e,t,n,o=!1){L.textContent=e,T.textContent=`${t} tiles â€¢ ${te(n)}`,o?(A.textContent="ðŸ“¦ Download Capture Bundle",A.onclick=V,k.classList.add("hidden")):(A.textContent="â¬‡ï¸ Download Archive",A.onclick=K,k.classList.remove("hidden")),D("complete")}function J(){n=[],o=0,r=0,s.clear(),l=null,a=null,d=null,P(),D("idle")}function K(){a&&d&&chrome.runtime.sendMessage({type:"DOWNLOAD_FILE",url:a,filename:d})}function V(){if(l&&d){const e=d.replace(".zip",".webmap-capture.json");chrome.runtime.sendMessage({type:"DOWNLOAD_BUNDLE",bundle:l,filename:e})}}const Y=[/\/sprite(@\dx)?\.(png|json)(\?|$)/i,/\/sprites?\//i],Z=[/\/fonts\/[^/]+\/\d+-\d+\.pbf/i,/\/glyphs?\//i];function Q(e){const t=e.match(/\/(sprite(@\dx)?\.(png|json))(\?|$)/i),n=t?t[1]:"sprite.png",o=t&&t[2]?t[2].substring(1):"1x",r=n.endsWith(".json")?"json":"image";return{filename:n,variant:o,contentType:r}}function X(e){const t=e.match(/\/fonts\/([^/]+)\/(\d+-\d+)\.pbf/i);return t?{fontStack:decodeURIComponent(t[1]),range:t[2]}:{fontStack:"unknown",range:"0-255"}}function ee(e){return new Promise(t=>{chrome.devtools.inspectedWindow.eval(`(() => {\n        return new Promise((resolve) => {\n          chrome.runtime.sendMessage(${JSON.stringify(e)}, resolve);\n        });\n      })()`,(e,n)=>{n?(console.error("Content script error:",n),t(null)):t(e)})})}function te(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]}document.addEventListener("DOMContentLoaded",function(){!function(){y.addEventListener("click",O),C.addEventListener("click",F),B.addEventListener("click",N),k.addEventListener("click",V),$.addEventListener("click",J),z.addEventListener("click",J);const e=document.getElementById("options-header");e&&e.addEventListener("click",U)}(),P(),D("idle")})}()})();