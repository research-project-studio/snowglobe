(()=>{"use strict";!function(){let e=!1,t=0,n=[],o=0,s=0,r=new Set,i=null,d=null,l=null,c=null;const a=document.getElementById("idle-state"),u=document.getElementById("recording-state"),m=document.getElementById("processing-state"),p=document.getElementById("complete-state"),g=document.getElementById("error-state"),h=document.getElementById("map-status"),y=document.getElementById("start-btn"),v=document.getElementById("recording-duration"),b=document.getElementById("stat-tiles"),w=document.getElementById("stat-requests"),E=document.getElementById("stat-size"),f=document.getElementById("stat-zooms"),C=document.getElementById("tile-list"),I=document.getElementById("stop-btn"),B=document.getElementById("cancel-btn"),L=(document.getElementById("processing-title"),document.getElementById("processing-message")),x=document.getElementById("progress-fill"),S=document.getElementById("progress-label"),T=document.getElementById("complete-filename"),A=document.getElementById("complete-stats"),z=document.getElementById("download-btn"),M=document.getElementById("download-bundle-btn"),$=document.getElementById("new-capture-btn"),D=document.getElementById("error-message"),P=document.getElementById("retry-btn");async function k(){try{const e=await J({type:"GET_MAPS"});if(e&&e.count>0){const t=e.maps.map(e=>e.type).join(", ");h.textContent=`${e.count} map${e.count>1?"s":""} detected (${t})`}else h.textContent="No maps detected on this page"}catch(e){h.textContent="Unable to detect maps"}}function R(e){switch(a.classList.add("hidden"),u.classList.add("hidden"),m.classList.add("hidden"),p.classList.add("hidden"),g.classList.add("hidden"),e){case"idle":a.classList.remove("hidden");break;case"recording":u.classList.remove("hidden");break;case"processing":m.classList.remove("hidden");break;case"complete":p.classList.remove("hidden");break;case"error":g.classList.remove("hidden")}}function _(){console.log("[WebMap Archiver] Starting recording..."),e=!0,t=Date.now(),n=[],o=0,s=0,r.clear(),b.textContent="0",w.textContent="0",E.textContent="0 B",f.textContent="-",C.innerHTML='<p class="empty-message">Pan or zoom the map to capture tiles...</p>',chrome.devtools.network.onRequestFinished.addListener(W),i=setInterval(U,1e3),chrome.runtime.sendMessage({type:"CAPTURE_STARTED",tabId:chrome.devtools.inspectedWindow.tabId}),R("recording"),console.log("[WebMap Archiver] Recording started")}function W(t){if(!e)return;const o=t.request.url,s=t.response.content.mimeType||"",r=t.response.status,i=t.response.content.size||0;console.log(`[WebMap Archiver] Request: ${o.substring(0,80)}... (${s})`);const d=function(e){const t=[{regex:/\/(\d+)\/(\d+)\/(\d+)\.(pbf|mvt|png|jpg|jpeg|webp|avif)/,groups:[1,2,3]},{regex:/\/tiles\/(\d+)\/(\d+)\/(\d+)/,groups:[1,2,3]},{regex:/[?&]z=(\d+)&x=(\d+)&y=(\d+)/,groups:[1,2,3]},{regex:/\/(\d{1,2})\/(\d+)\/(\d+)(?:\.|\/|$|\?)/,groups:[1,2,3]}];for(const{regex:n,groups:o}of t){const t=e.match(n);if(t){const n=parseInt(t[o[0]]),s=parseInt(t[o[1]]),r=parseInt(t[o[2]]);if(n<0||n>22)continue;try{const t=new URL(e).hostname.split(".");let o=t[0];return("api"===o||"tiles"===o)&&t.length>1&&(o=t[1]),{coords:{z:n,x:s,y:r},source:o||"tiles"}}catch{return{coords:{z:n,x:s,y:r},source:"tiles"}}}}return null}(o),l={url:o,method:t.request.method,status:r,mimeType:s,size:i,isTile:null!==d,tileCoords:d?.coords,tileSource:d?.source};(null!==d||s.includes("json")||s.includes("pbf")||s.includes("protobuf")||o.includes("sprite")||o.includes("glyphs")||o.includes("style"))&&i<10485760?t.getContent((e,t)=>{e&&(l.body="base64"===t?e:btoa(e)),n.push(l),O(l)}):(n.push(l),O(l))}function O(e){if(w.textContent=n.length.toString(),s+=e.size,E.textContent=Y(s),e.isTile&&e.tileCoords){o++,b.textContent=o.toString(),r.add(e.tileCoords.z);const t=Array.from(r).sort((e,t)=>e-t);f.textContent=t.length>0?`${t[0]}-${t[t.length-1]}`:"-",function(e){const t=C.querySelector(".empty-message");t&&t.remove();const n=document.createElement("div");for(n.className="tile-item new",n.textContent=`z${e.tileCoords.z}/${e.tileCoords.x}/${e.tileCoords.y} (${e.tileSource})`,C.insertBefore(n,C.firstChild);C.children.length>20;)C.removeChild(C.lastChild)}(e),console.log(`[WebMap Archiver] âœ… Tile captured: z${e.tileCoords.z}/${e.tileCoords.x}/${e.tileCoords.y}`)}chrome.runtime.sendMessage({type:"CAPTURE_STATS_UPDATE",tabId:chrome.devtools.inspectedWindow.tabId,stats:{tileCount:o,totalRequests:n.length,estimatedSize:s,zoomLevels:Array.from(r)}})}function U(){const e=Math.floor((Date.now()-t)/1e3),n=Math.floor(e/60),o=e%60;v.textContent=`${n}:${o.toString().padStart(2,"0")}`}async function q(){console.log("[WebMap Archiver] Stopping recording..."),e=!1,chrome.devtools.network.onRequestFinished.removeListener(W),i&&(clearInterval(i),i=null),R("processing"),j(10,"Extracting map style...");try{const e=await J({type:"CAPTURE_STYLE"}),o=await J({type:"GET_PAGE_INFO"});j(30,"Building capture bundle...");const i=function(e,o){const i=n.filter(e=>e.isTile&&e.body&&e.tileCoords).map(e=>({z:e.tileCoords.z,x:e.tileCoords.x,y:e.tileCoords.y,source:e.tileSource||"tiles",data:e.body,format:e.mimeType.includes("png")?"png":"pbf"})),d={log:{version:"1.2",creator:{name:"WebMap Archiver",version:"0.2.0"},entries:n.map(e=>({startedDateTime:(new Date).toISOString(),request:{method:e.method,url:e.url,headers:[]},response:{status:e.status,statusText:"OK",headers:[],content:{size:e.size,mimeType:e.mimeType,text:e.body,encoding:e.body?"base64":void 0}},timings:{wait:0,receive:0}}))}};return{version:"1.0",metadata:{url:o.url,title:o.title,capturedAt:(new Date).toISOString(),userAgent:navigator.userAgent,mapLibrary:e?.mapLibrary,captureStats:{totalRequests:n.length,tileCount:i.length,zoomLevels:Array.from(r).sort((e,t)=>e-t),estimatedSize:s,recordingDuration:Date.now()-t}},viewport:e?.viewport?{center:[e.viewport.center.lng,e.viewport.center.lat],zoom:e.viewport.zoom,bounds:e.viewport.bounds?[[e.viewport.bounds._sw.lng,e.viewport.bounds._sw.lat],[e.viewport.bounds._ne.lng,e.viewport.bounds._ne.lat]]:void 0,bearing:e.viewport.bearing||0,pitch:e.viewport.pitch||0}:{center:[0,0],zoom:10},style:e?.style,har:d,tiles:i}}(e,o);d=i,console.log("[WebMap Archiver] Bundle built:",{tiles:i.tiles?.length||0,harEntries:i.har?.log?.entries?.length||0,hasStyle:!!i.style}),j(50,"Uploading to cloud...");const a=await chrome.runtime.sendMessage({type:"PROCESS_BUNDLE",bundle:i});if(a.success)j(90,"Preparing download..."),l=a.downloadUrl,c=a.filename,chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),F(a.filename,i.tiles?.length||0,a.size||0);else{if(!a.fallbackToDownload)throw new Error(a.error||"Processing failed");c=function(e){try{return`${new URL(e).hostname.replace(/\./g,"-")}-${(new Date).toISOString().split("T")[0]}.webmap-capture.json`}catch{return`webmap-${Date.now()}.webmap-capture.json`}}(o.url),chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),F(c,i.tiles?.length||0,s,!0)}}catch(e){console.error("[WebMap Archiver] Error:",e),o=String(e),D.textContent=o,R("error")}var o}function N(){e=!1,chrome.devtools.network.onRequestFinished.removeListener(W),i&&(clearInterval(i),i=null),chrome.runtime.sendMessage({type:"CAPTURE_STOPPED",tabId:chrome.devtools.inspectedWindow.tabId}),G()}function j(e,t){x.style.width=`${e}%`,S.textContent=`${e}%`,L.textContent=t}function F(e,t,n,o=!1){T.textContent=e,A.textContent=`${t} tiles â€¢ ${Y(n)}`,o?(z.textContent="ðŸ“¦ Download Capture Bundle",z.onclick=H,M.classList.add("hidden")):(z.textContent="â¬‡ï¸ Download Archive",z.onclick=K,M.classList.remove("hidden")),R("complete")}function G(){n=[],o=0,s=0,r.clear(),d=null,l=null,c=null,k(),R("idle")}function K(){l&&c&&chrome.runtime.sendMessage({type:"DOWNLOAD_FILE",url:l,filename:c})}function H(){if(d&&c){const e=c.replace(".zip",".webmap-capture.json");chrome.runtime.sendMessage({type:"DOWNLOAD_BUNDLE",bundle:d,filename:e})}}function J(e){return new Promise(t=>{chrome.devtools.inspectedWindow.eval(`(() => {\n        return new Promise((resolve) => {\n          chrome.runtime.sendMessage(${JSON.stringify(e)}, resolve);\n        });\n      })()`,(e,n)=>{n?(console.error("Content script error:",n),t(null)):t(e)})})}function Y(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]}document.addEventListener("DOMContentLoaded",function(){y.addEventListener("click",_),I.addEventListener("click",q),B.addEventListener("click",N),z.addEventListener("click",K),M.addEventListener("click",H),$.addEventListener("click",G),P.addEventListener("click",G),k(),R("idle")})}()})();